# Everything here is HTTP (not https and certificates)

##########################
## From common

# DB with no data dir, i restart every time from zero?
devdb:
    extends:
        file: common.yml
        service: rdb
# APIs in debug mode
pycode:
    extends:
        file: common.yml
        service: pycode
updata:
    extends:
        file: common.yml
        service: updata
devapi:
    extends:
        file: common.yml
        service: api
    command: python main.py
    #command: sleep 123987123
    exposes:
        - "5000"
    volumes_from:
        - pycode
    links:
        - devdb:db
    volumes:
        - ../data/backup:/backup:rw
devfapi:
    extends:
        file: common.yml
        service: fileapi
    command: python file.py
    exposes:
        - "6000"
    volumes_from:
        - pycode
        - updata

##########################
## PROXY
devproxy:
    extends:
        file: common.yml
        service: proxy
    ports:
        - "4321:9090" #the debug db chateau
        - "5432:7070" #the debug db monitor
    links:
        - devapi:api # i need to know the internal container which exposes api
        - devfapi:fapi
        - webdev:capi
        - devdb:rmonitor
    volumes:
        - ../docker/proxy/dev-enabled.conf:/etc/nginx/sites-enabled/development
    volumes_from:
        - updata

##########################
## Only for development?

# Db init with db, table and admin user
devdbinit:
    extends:
        file: common.yml
        service: api
    command: python devinit.py
    links:
        - devdb:db
    volumes_from:
        - pycode
# Nodejs: Database admin and dist build
webdev:
    build: ../docker/jsdev
    command: chateau
    volumes:
        - ../yoapp:/opt/jsapp
    links:
        - devdb:db

##########################
providerdata:
    image: busybox
    command: /bin/sh -c "cd /var/lib; mkdir postgresql; chown 999:999 postgresql"
    # volumes:
    #     # Boot2docker bug: http://j.mp/1FMm5qj
    #     - ../data/psgr:/var/lib/postgresql/data
providerdb:
    image: postgres:9.4
    # /usr/lib/postgresql/9.4/bin/pg_ctl reload
    environment:
        POSTGRES_USER: docker
        POSTGRES_PASSWORD: test
    volumes_from:
        - providerdata
    volumes:
        # Init file && Access security
        - ../docker/init/psql.init.sh:/docker-entrypoint-initdb.d/setup-my-schema.sh
## Switch to XL: http://www.slideshare.net/mason_s/postgres-xl-scaling
## http://www.postmind.net/pgxl_docker-en.html
provider:
    extends:
        file: common.yml
        service: api
    #command: sleep 12456789
    command: python testapp.py
    volumes_from:
        - pycode
    ports:
        - "8888:80"
    links:
        - providerdb:db

##########################
#Also:
#docker run -ti -v /var/run/docker.sock:/var/run/docker.sock icecrime/docker-mon
