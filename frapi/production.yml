# Everything here should be HTTPS!
# use certificates!!

##############################
## Production database
dbdata:
  extends:
    file: common.yml
    service: dbdata
rdb:
    extends:
        file: common.yml
        service: rdb
    volumes_from:
         - dbdata     # Import data directory from storage container
# We can join as many as we want
rdbslave:
    image: rethinkdb
    command: rethinkdb --join master:29015 --bind all
    links:
        - rdb:master
# To clean:
#$ docker exec -it frapi_api_1 python scripts/clean_cluster_issues.py

##############################
## REST API
pycode:
    extends:
        file: common.yml
        service: pycode
updata:
    extends:
        file: common.yml
        service: updata
api:
    extends:
        file: common.yml
        service: api
    environment:
        APP_MODE: 'prod'
    # if i use environment variables it does not work...
    command: gunicorn -c conf/gunicorn.conf.py server:app
    exposes:
        - "5000"
    volumes_from:
        - pycode
        - updata
    links:
        - rdb:db

##########################
## PROXY and HTTPS
sslproxy:
    extends:
        file: common.yml
        service: proxy
    volumes:
        - ../certificates/privateUnKey.pem:/etc/nginx/ssl/server.key
        - ../certificates/publicCert.pem:/etc/nginx/ssl/server.crt
        - ../docker/proxy/ssl-enabled.conf:/etc/nginx/sites-enabled/production
    ports:
        - "80:80"
        - "443:443"
    links:
        - api:api
    volumes_from:
        - updata

##############################
## Periodic tasks
backupdata:
    extends:
        file: common.yml
        service: backupdata
tasker:
    build: ../docker/tasks
    links:
        - rdb:db #Slave?
    volumes_from:
        - backupdata
